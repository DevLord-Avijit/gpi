<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe, #fef2f2);
      min-height: 100vh;
    }

    .glass {
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    .animate-fadeIn {
      animation: fadeIn 0.6s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pulse {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .transaction-card {
      transition: all 0.3s ease;
    }

    .transaction-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    /* Responsive Grid */
    @media (min-width: 768px) {
      .grid-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
    }
  </style>
</head>

<body class="font-sans text-gray-800 flex justify-center p-4 md:p-10">

  <div class="w-full max-w-5xl space-y-6">
    <h1 class="text-3xl md:text-4xl font-bold text-center text-blue-700">ðŸ’¸ GPI Dashboard</h1>

    <div class="grid-layout">
      <!-- Balance -->
      <div class="glass rounded-2xl p-6 text-center animate-fadeIn">
        <h2 class="text-xl font-semibold text-gray-700">Welcome, {{ user.name }}</h2>
        <p id="balance-display" class="text-4xl font-extrabold text-gray-900 mt-3 transition-all">{{ user.balance }}
          GPI</p>
      </div>

      <!-- Payment -->
      <div class="glass p-6 rounded-2xl animate-fadeIn">
        <h3 class="text-lg font-semibold mb-3">Send Payment</h3>
        <form id="payment-form" method="POST" class="space-y-3">
          <input type="text" name="to" id="to" placeholder="Recipient GPI ID"
            class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
          <input type="number" name="amount" id="amount" step="0.01" min="1" placeholder="Amount"
            class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
          <button id="send-btn" type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition-all duration-300 hover:shadow-lg">
            Send Payment ðŸš€
          </button>
        </form>

        <button id="open-scanner"
          class="w-full mt-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 rounded-lg flex items-center justify-center transition-all duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l3-3h12l3 3v11a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" />
            <circle cx="12" cy="13" r="3" stroke="currentColor" stroke-width="2" />
          </svg>
          Scan QR
        </button>
      </div>
    </div>

    <!-- Transactions -->
    <div class="glass rounded-2xl p-6 animate-fadeIn">
      <h3 class="text-lg font-semibold mb-4">Recent Transactions</h3>
      <div id="tx-list" class="space-y-3 max-h-[300px] overflow-y-auto">
        {% for tx in transactions %}
        <div
          class="transaction-card bg-white bg-opacity-70 p-4 rounded-xl flex justify-between items-center {% if tx.from == gpi_id %}border-l-4 border-red-500{% else %}border-l-4 border-green-500{% endif %}">
          <div>
            <p class="font-medium">{% if tx.from == gpi_id %}Sent to {{ tx.to }}{% else %}Received from {{ tx.from }}{%
              endif %}</p>
            <p class="text-gray-500 text-sm">{{ tx.timestamp }}</p>
          </div>
          <p class="font-semibold {% if tx.from == gpi_id %}text-red-500{% else %}text-green-600{% endif %}">
            {{ tx.amount }} GPI</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- QR Code -->
    <div class="glass p-6 rounded-2xl text-center animate-fadeIn">
      <h3 class="text-lg font-semibold mb-3">Your QR Code</h3>
      <img src="{{ url_for('generate_qr', gpi_id=gpi_id) }}" alt="QR Code" class="mx-auto w-40 h-40 rounded-lg shadow">
      <p class="text-sm text-gray-600 mt-2">{{ gpi_id }}</p>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scanner-modal"
    class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 transition-all duration-300">
    <div class="bg-white p-4 rounded-xl w-11/12 max-w-sm relative">
      <button id="close-scanner" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      <h3 class="text-lg font-semibold mb-2">Scan QR Code</h3>
      <div id="qr-reader" class="w-full"></div>
      <button id="switch-camera"
        class="bg-gray-100 px-3 py-1 rounded mt-3 hover:bg-gray-200 transition-all">Switch Camera</button>
    </div>
  </div>

  <script>
    const socket = io();
    const gpi_id = "{{ gpi_id }}";
    let balance = parseFloat("{{ user.balance }}");

    const balanceDisplay = document.getElementById("balance-display");
    const sendBtn = document.getElementById("send-btn");

    function animateBalance(newVal) {
      const currentVal = parseFloat(balanceDisplay.innerText);
      const diff = newVal - currentVal;
      let start = 0;
      const step = diff / 20;
      const interval = setInterval(() => {
        start += step;
        balanceDisplay.innerText = (currentVal + start).toFixed(2) + " GPI";
        if (Math.abs(start) >= Math.abs(diff)) {
          balanceDisplay.innerText = newVal.toFixed(2) + " GPI";
          clearInterval(interval);
        }
      }, 20);
    }

    socket.emit('join', { gpi_id });

    socket.on('transaction_update', data => {
      const tx = data.tx;
      const container = document.getElementById('tx-list');
      const card = document.createElement('div');
      card.className = `transaction-card bg-white bg-opacity-70 p-4 rounded-xl flex justify-between items-center ${tx.from === gpi_id ? 'border-l-4 border-red-500' : 'border-l-4 border-green-500'}`;
      card.innerHTML = `
        <div>
          <p class="font-medium">${tx.from === gpi_id ? 'Sent to ' + tx.to : 'Received from ' + tx.from}</p>
          <p class="text-gray-500 text-sm">${tx.timestamp}</p>
        </div>
        <p class="font-semibold ${tx.from === gpi_id ? 'text-red-500' : 'text-green-600'}">${tx.amount} GPI</p>
      `;
      container.prepend(card);

      if (tx.from === gpi_id) balance -= parseFloat(tx.amount);
      if (tx.to === gpi_id) balance += parseFloat(tx.amount);
      animateBalance(balance);
    });

    // Payment animation
    document.getElementById("payment-form").addEventListener("submit", (e) => {
      sendBtn.classList.add("pulse");
      setTimeout(() => sendBtn.classList.remove("pulse"), 1500);
    });

    // QR Scanner
    const scannerModal = document.getElementById('scanner-modal');
    const openBtn = document.getElementById('open-scanner');
    const closeBtn = document.getElementById('close-scanner');
    const switchBtn = document.getElementById('switch-camera');
    let html5QrcodeScanner = null;
    let cameras = [];
    let currentCameraId = null;

    openBtn.addEventListener('click', async () => {
      scannerModal.classList.remove('hidden', 'opacity-0');
      cameras = await Html5Qrcode.getCameras();
      currentCameraId = cameras[0].id;
      startScanner(currentCameraId);
    });

    closeBtn.addEventListener('click', () => {
      scannerModal.classList.add('hidden');
      html5QrcodeScanner?.stop().catch(console.error);
    });

    switchBtn.addEventListener('click', () => {
      if (cameras.length > 1) {
        const index = cameras.findIndex(cam => cam.id === currentCameraId);
        currentCameraId = cameras[(index + 1) % cameras.length].id;
        html5QrcodeScanner.stop().then(() => startScanner(currentCameraId));
      }
    });

    function startScanner(cameraId) {
      html5QrcodeScanner = new Html5Qrcode("qr-reader");
      html5QrcodeScanner.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        decodedText => {
          html5QrcodeScanner.stop().then(() => {
            scannerModal.classList.add('hidden');
            if (!decodedText.startsWith("gpi://pay?to=")) {
              alert("Invalid QR!");
              return;
            }
            const params = new URLSearchParams(decodedText.split('?')[1]);
            const toGpi = params.get('to');
            if (!toGpi || toGpi === gpi_id) {
              alert("Cannot pay this QR!");
              return;
            }
            document.getElementById('to').value = toGpi;
            document.getElementById('amount').focus();
          });
        }
      );
    }
  </script>
</body>

</html>
